"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const ajv_1 = __importDefault(require("ajv"));
const path_1 = require("path");
const utils_1 = require("./utils");
const schema_validator_1 = require("./schema-validator");
const objection_1 = require("./generators/objection");
const knex_1 = require("./generators/knex");
async function handleGenerateObjection(params) {
    params.templateDir = params.templateDir
        ? params.templateDir
        : path_1.resolve(__dirname, 'templates', 'objection');
    await handleGenerate(objection_1.ObjectionGenerator, params);
    console.log('Models generated in:', params.outDir);
}
exports.handleGenerateObjection = handleGenerateObjection;
async function handleGenerateKnex(params) {
    params.templateDir = params.templateDir
        ? params.templateDir
        : path_1.resolve(__dirname, 'templates', 'knex');
    await handleGenerate(knex_1.KnexGenerator, params);
    console.log('Migration generated in:', params.outDir);
}
exports.handleGenerateKnex = handleGenerateKnex;
async function handleGenerate(Generator, params) {
    try {
        const specPath = path_1.resolve(process.cwd(), params.specFile);
        const outDir = path_1.resolve(process.cwd(), params.outDir);
        const data = await utils_1.loadYaml(specPath);
        console.log('Validating YAML spec');
        await schema_validator_1.validateConfig(data);
        console.log('Generating');
        const dereferenced = await utils_1.dereference(data, path_1.dirname(specPath));
        const generator = new Generator(dereferenced, params.templateDir, outDir);
        await generator.init();
        await generator.generate();
    }
    catch (err) {
        if (err instanceof ajv_1.default.ValidationError) {
            console.log(JSON.stringify(err.errors, null, 2));
            process.exit(1);
        }
        console.log(err.message);
        process.exit(1);
    }
}
exports.handleGenerate = handleGenerate;
//# sourceMappingURL=handle-generate.js.map