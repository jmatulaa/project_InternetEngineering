"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const js_yaml_1 = require("js-yaml");
const fs_1 = require("fs");
const walk_1 = __importDefault(require("@fcostarodrigo/walk"));
const json_schema_ref_parser_1 = __importDefault(require("@apidevtools/json-schema-ref-parser"));
async function loadYaml(file) {
    return js_yaml_1.safeLoad(fs_1.readFileSync(file, 'utf8'));
}
exports.loadYaml = loadYaml;
async function dereference(config, baseDir) {
    const data = (await json_schema_ref_parser_1.default.dereference(`${baseDir}/`, config, {
        dereference: {
            circular: 'ignore'
        }
    }));
    // Recurse through the structure and flatten allOf references
    // @ts-ignore
    traverse(data, (obj, key, value) => {
        var _a;
        if ((_a = obj[key]) === null || _a === void 0 ? void 0 : _a.allOf) {
            obj[key] = obj[key].allOf.reduce((accum, curr) => {
                return {
                    ...accum,
                    ...curr
                };
            }, {});
        }
    });
    return data;
}
exports.dereference = dereference;
async function readDirs(path) {
    const files = [];
    for await (const file of walk_1.default(path)) {
        files.push(file);
    }
    return files;
}
exports.readDirs = readDirs;
// https://gist.github.com/sphvn/dcdf9d683458f879f593
function traverse(o, fn) {
    for (const i in o) {
        fn.apply(this, [o, i, o[i]]);
        if (o[i] !== null && typeof o[i] === 'object') {
            traverse(o[i], fn);
        }
    }
}
exports.traverse = traverse;
//# sourceMappingURL=utils.js.map